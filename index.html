<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processing</title>
</head>

<body>
    <h1>Image Processing</h1>

    <!-- Form to upload images -->
    <form id="uploadForm" enctype="multipart/form-data">
        <label for="cfImage">Upload CF (Chest X-ray) Image:</label>
        <input type="file" name="cfImage" id="cfImage">
        <br>
        <input type="button" value="Upload Images" onclick="uploadImages()">
    </form>

    <hr>

    <!-- Button to generate images -->
    <button onclick="generateImages()">Generate Images</button>

    <!-- Container to display processed images -->
    <div id="processedImages">
        <!-- Processed images will be added here -->
    </div>

    <script>
        var cfFileName = '';
        var octFileName = '';
        var taskName = new FormData();

        function uploadImages() {
            var cfFormData = new FormData();
            var cfFileInput = document.getElementById('cfImage');

            cfFormData.append('file', cfFileInput.files[0]);

            cfFileName = cfFileInput.files[0].name;

            taskName.append('name', cfFileName.split('.').slice(0, -1).join('.'));

            var nameXhr = new XMLHttpRequest();
            var cfXhr = new XMLHttpRequest();

            nameXhr.open('POST', 'http://localhost:8080/uploadName', true);
            cfXhr.open('POST', 'http://localhost:8080/uploadCF', true);
            cfXhr.onload = function () {
                if (cfXhr.status == 200) {
                    alert('CF Image uploaded successfully');
                } else {
                    alert('Error uploading CF image');
                }
            };
            nameXhr.onload = function () {
                if (nameXhr.status == 200) {
                    cfXhr.send(cfFormData);
                } else {
                    alert('Error uploading name');
                }
            };

            nameXhr.send(taskName);
            taskName.delete('name');
        }

        function generateImages() {
            var xhr = new XMLHttpRequest();

            xhr.open('GET', 'http://localhost:8080/generateImages', true);

            xhr.responseType = 'arraybuffer'; // 设置响应类型为数组缓冲区

            xhr.onload = function () {
                if (xhr.status == 200) {
                    var arrayBuffer = xhr.response;
                    var byteArray = new Uint8Array(arrayBuffer); // 将数组缓冲区转换为字节数组
                    var blob = new Blob([byteArray], { type: 'image/png' }); // 创建图像 Blob 对象
                    var imageUrl = URL.createObjectURL(blob); // 生成图像 URL

                    var img = document.createElement('img');
                    img.src = imageUrl;

                    var processedImages = document.getElementById('processedImages');
                    processedImages.appendChild(img);
                } else {
                    alert('Error generating images');
                }
            };

            xhr.send();
        }        
    </script>
</body>

</html>